generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Lobby {
  id                 String   @id @default(cuid())
  code               String   @unique
  ownerId            String
  targetScore        Int      @default(7)
  emergencyVotesEnabled Boolean @default(false)
  bettingEnabled     Boolean @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  players            Player[]
  rounds             Round[]
  emergencyVotes     EmergencyVote[]
  bets               Bet[]
}

model Player {
  id        String   @id @default(cuid())
  lobbyId   String
  name      String
  score     Int      @default(0)
  isOnline  Boolean  @default(true)
  joinedAt  DateTime @default(now())

  lobby     Lobby    @relation(fields: [lobbyId], references: [id], onDelete: Cascade)
  hints     Hint[]
  votes     Vote[]
  votesReceived Vote[] @relation("VoteTarget")
  emergencyVotesInitiated EmergencyVote[]
  betsPlaced Bet[] @relation("Bettor")
  betsTargeted Bet[] @relation("BetTarget")

  @@unique([lobbyId, name])
}

model Round {
  id          String   @id @default(cuid())
  lobbyId     String
  roundNumber Int
  word        String
  category    String   @default("Thing")
  imposterId  String
  turnOrder   String[] // Array of player IDs
  currentTurn Int      @default(0)
  status      RoundStatus @default(WAITING)
  createdAt   DateTime @default(now())

  lobby       Lobby    @relation(fields: [lobbyId], references: [id], onDelete: Cascade)
  hints       Hint[]
  votes       Vote[]
  bets        Bet[]
  emergencyVote EmergencyVote?

  @@unique([lobbyId, roundNumber])
}

model Hint {
  id        String   @id @default(cuid())
  roundId   String
  playerId  String
  text      String
  turnIndex Int
  createdAt DateTime @default(now())

  round     Round    @relation(fields: [roundId], references: [id], onDelete: Cascade)
  player    Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([roundId, turnIndex])
}

model Vote {
  id         String   @id @default(cuid())
  roundId    String
  voterId    String
  suspectId  String
  createdAt  DateTime @default(now())

  round      Round    @relation(fields: [roundId], references: [id], onDelete: Cascade)
  voter      Player   @relation(fields: [voterId], references: [id], onDelete: Cascade)
  suspect    Player   @relation("VoteTarget", fields: [suspectId], references: [id], onDelete: Cascade)

  @@unique([roundId, voterId])
}

model EmergencyVote {
  id          String   @id @default(cuid())
  lobbyId     String
  roundId     String
  initiatorId String
  createdAt   DateTime @default(now())

  lobby       Lobby    @relation(fields: [lobbyId], references: [id], onDelete: Cascade)
  round       Round    @relation(fields: [roundId], references: [id], onDelete: Cascade)
  initiator   Player   @relation(fields: [initiatorId], references: [id], onDelete: Cascade)

  @@unique([roundId])
}

model Bet {
  id         String   @id @default(cuid())
  lobbyId    String
  roundId    String
  bettorId   String
  targetId   String
  amount     Int      // 1-3 points
  payout     Int      @default(0) // Calculated after round
  createdAt  DateTime @default(now())

  lobby      Lobby    @relation(fields: [lobbyId], references: [id], onDelete: Cascade)
  round      Round    @relation(fields: [roundId], references: [id], onDelete: Cascade)
  bettor     Player   @relation("Bettor", fields: [bettorId], references: [id], onDelete: Cascade)
  target     Player   @relation("BetTarget", fields: [targetId], references: [id], onDelete: Cascade)

  @@unique([roundId, bettorId])
}

enum RoundStatus {
  WAITING
  IN_PROGRESS
  HINTS_COMPLETE
  BETTING
  VOTING
  EMERGENCY_VOTING
  GUESSING
  COMPLETE
}